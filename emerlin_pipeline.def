BootStrap: library
From: ubuntu:18.04

%files
	run_emerlin_pipeline.bash
	dowsclean.py
	default_params_WIDE.json
	default_params_LOWMEM.json
	default_params_NODROPOUT.json

%help
	There are two main ways to interact with this container:

	[1] > singularity shell eMERLIN_CASA_pipeline.img

	This opens up an interactive shell within the container. You can use this mode to copy the inputs.ini and default_params.json file to the working directory in order to edit them for a custom pipeline run:

	> cp /eMERLIN_CASA_pipeline/inputs.ini .
	> cp /eMERLIN_CASA_pipeline/default_params.json .

	The pipeline can then be called from within this interactive shell using the standard syntax, e.g.

	> casa -c /eMERLIN_CASA_pipeline/eMERLIN_CASA_pipeline.py -r all

	See instructions on Javier Moldon's GitHub page for more details:

	**************************************************
	https://github.com/e-merlin/eMERLIN_CASA_pipeline
	**************************************************


	[2] > singularity run eMERLIN_CASA_pipeline.img

	This begins a completely automated, headless pipeline run using either (a) the inputs.ini and default_params.json files located in the current directory, provided these exist, or (b) the default inputs.ini and default_params.json files that come with the pipeline.

	This is the preferred mode of interacting with the pipeline if you wish to use machines without X11 installed (i.e. SLURM-managed HPC nodes), and requires you to provide an appropriate inputs.ini file at the time of execution.

	In this mode, the eMERLIN_CASA_pipeline.img should be located in the same directory as inputs.ini and in the same directory as the eMERLIN FITS-IDI file you wish to process. The inputs.ini file should have "fits_path" set to "./".

	After the run, a tar file called "pipelined.tar.gz" is created, containing the results of the pipeline run and all associated weblog files.


%runscript
	. /conda/etc/profile.d/conda.sh
	conda activate astroconda
	xvfb-run --auto-servernum bash /run_emerlin_pipeline.bash

%startscript
	echo "This is what happens when you start the container...
	. /conda/etc/profile.d/conda.sh
	conda activate astroconda
	echo "You have started the container!"

%post
	export CASASTRING=casa-pipeline-release-5.6.2-2.el7

	#Update and install KERN packages
	apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install software-properties-common time -y
        add-apt-repository -s ppa:kernsuite/kern-5
        apt-add-repository multiverse
        apt-add-repository restricted
        apt-get update
	DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -y
        DEBIAN_FRONTEND=noninteractive apt-get install libgtk3* htop glances git apt-utils vim -y
        DEBIAN_FRONTEND=noninteractive apt-get install libcurl3 -y
        DEBIAN_FRONTEND=noninteractive apt-get install wsclean aoflagger carta chgcentre ddfacet factor libidg miriad obit parseltongue pybdsf tirific python-pyfftw python3-pyfftw python-pyfftw-doc python3-pip xvfb -y
	DEBIAN_FRONTEND=noninteractive apt-get install dstat* wget git-lfs bash -y
        apt-get install -y build-essential cmake gfortran g++ gcc libncurses5-dev libreadline-dev flex bison libblas-dev liblapacke-dev wcslib-dev libcfitsio-dev emacs nano
        apt-get install -y libhdf5-dev libfftw3-dev python-numpy-dev libboost-python-dev libpython3.6-dev libqt4-dev libpthread-stubs0-dev fort77 pthread* rsync
	pip3 install numpy scipy matplotlib ipython jupyter pandas sympy nose psutil ipywidgets ipyparallel bokeh scikit-learn
	
	#Install Anaconda + Astroconda + some additional useful packages
	export SINGULARITY_SHELL=/bin/bash
	wget https://repo.anaconda.com/archive/Anaconda3-2019.10-Linux-x86_64.sh -O conda.sh
	bash conda.sh -b -p conda
	. /conda/etc/profile.d/conda.sh
	conda update -y -n root conda
	conda update --all
	conda config --add channels http://ssb.stsci.edu/astroconda
	conda create -n astroconda stsci
	conda install -c conda-forge galsim astromatic-swarp astromatic-source-extractor astromatic-stiff -n astroconda
	conda install -c pkgw-forge ds9
	
	#Prepare and install CASA
	wget https://casa.nrao.edu/download/distro/casa-pipeline/release/el7/$CASASTRING.tar.gz
	tar -zxvf $CASASTRING.tar.gz

	#Install eMERLIN CASA pipeline, but disable auto-update of "data" directory
	#to respect the fact that this container is a read-only FS
	git clone https://github.com/e-merlin/eMERLIN_CASA_pipeline.git
	sed -i -e 's/"update_casa-data"       : true,/"update_casa-data"       : false,/g' /eMERLIN_CASA_pipeline/default_params.json
	sed -i -e "s/if t0 > datetime.datetime(2019,1,25,17,15,0) and s == 'pipeline':/if t0 > datetime.datetime(2019,1,25,17,15,0):/g" /eMERLIN_CASA_pipeline/functions/eMCP_functions.py
	sed -i -e "s/os.system('scp -pr {0}.{1}:{2} \/pipeline1\/emerlin\/files\/'.format(s1,s2,loc))/pass/g" /eMERLIN_CASA_pipeline/functions/eMCP_functions.py
	sed -i -e "s/loc = '\/home\/emerlin\/jmoldon\/otcx\/antenna_monitor.log'/loc = '.\/antenna_monitor.log'/g" /eMERLIN_CASA_pipeline/functions/eMCP_functions.py
	sed -i -e "s/logfile = '\/pipeline1\/emerlin\/files\/antenna_monitor.log'/logfile = '.\/antenna_monitor.log'/g" /eMERLIN_CASA_pipeline/functions/eMCP_functions.py

	#Update UTC table for CASA
	rsync -avz rsync://casa-rsync.nrao.edu/casa-data /$CASASTRING/data

	#Download and untar the analysis_utils package
	wget ftp://ftp.cv.nrao.edu/pub/casaguides/analysis_scripts.tar
	tar -xvf analysis_scripts.tar -C /

	#Clear up any old installation files
	rm -r conda.sh analysis_scripts.tar $CASASTRING.tar.gz
	DEBIAN_FRONTEND=noninteractive apt autoremove -y

	#Add custom WSCLEAN script
	mkdir /scripts
	cp dowsclean.py /scripts
	cp default_params_WIDE.json /scripts	
	cp default_params_LOWMEM.json /scripts
	cp default_params_NODROPOUT.json /scripts	

	
%test
	. /conda/etc/profile.d/conda.sh
	conda activate astroconda
	python --version
	
%environment
	export CASASTRING=casa-pipeline-release-5.6.2-2.el7
	
	export LC_ALL=C
	export LC_CTYPE="en_US.UTF-8"
	unset XDG_RUNTIME_DIR

	export PATH="/conda/bin:$PATH"
	export PATH="/$CASASTRING/bin:$PATH"
	export PYTHONPATH="$CASAROOT/$CASA_ARCH/lib/python2.7/:$PYTHONPATH"
	export LD_LIBRARY_PATH="$CASAROOT/$CASA_ARCH/lib:$LD_LIBRARY_PATH"
	export CASA_ENABLE_TELEMETRY=false

	
%labels
	Author: Alasdair Thomson
	Version: 1.0
